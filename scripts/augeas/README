NUT and Augeas: usage and integration notes
===========================================

Introduction
------------

Configuration has long been one of the two main nut weaknesses. This is
mostly due to the framework nature of NUT, and its many components and
features which makes NUT configuration a very complex task.

In order to address this point, NUT now provides configuration tools and
manipulation abstraction, to anybody who want to manipulate NUT configuration,
through Augeas lenses and modules.

From Augeas homepage:
"Augeas is a configuration editing tool. It parses configuration files in their
native formats and transforms them into a tree. Configuration changes are made
by manipulating this tree and saving it back into native config files."

In other words, Augeas is the dreamed Registry, with all pros (uniform interface
and tools) but without the cons (mainly, the treat to FLOSS liberty on
configuration files format, and its dubbed to fail standardisation).

Requirements
------------

Augeas
~~~~~~

Having Augeas (http://augeas.net) installed.
You will need at least version 0.5.1 (prior versions may work too, reports are
welcome).

On Debian and derivatives, do the following:
	apt-get install augeas-lenses augeas-tools
And optionaly:
	apt-get install libaugeas0 python-augeas

On RedHat and derivatives, you have to install the packages 'augeas' and
'augeas-libs'.

NUT lenses and modules for Augeas
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

These are the *.aug files in the present directory.

You can either install the files to the right location on your system, or use
these from the current directory. The latter is preferable for the moment.


Create a test sandbox
---------------------

NOTE: for now, it's easier to include an existing /etc/nut/ directory.

	export AUGEAS_ROOT=./augeas-sandbox
	mkdir $AUGEAS_ROOT
	sudo cp -pr /etc/nut $AUGEAS_ROOT
	sudo chown -R $(id -nu):$(id -ng) $AUGEAS_ROOT


Start testing
-------------

	augtool -b

You will enter the Augeas shell. From there, you can perform different actions
like:

- list existing nut related files:
	augtool> ls /files/etc/nut/
	upsd.users/ = (none)
	ups.conf/ = (none)
	upsd.conf/ = (none

NOTE: if you don't see anything, you may search for error messages by using:
+
	augtool> ls /augeas/files/etc/nut/*/errors
and
	augtool> get /augeas/files/etc/nut/ups.conf/error/message
	/augeas/files/etc/nut/ups.conf/error/message = Permission denied

- create a new device entry (in ups.conf), called 'augtest':

	augtool> set /files/etc/nut/ups.conf/augtest/driver dummy-ups
	augtool> set /files/etc/nut/ups.conf/augtest/port auto
	augtool> save

- list the devices using the 'usbhid-ups' driver:

	augtool> match /files/etc/nut/ups.conf/*/driver usbhid-ups


For more information, refer to Augeas documentation:
- http://augeas.net/tour.html
- http://augeas.net/docs/index.html


test the conformity testing module
----------------------------------
$ augparse -I ./ ./test_nut.aug

